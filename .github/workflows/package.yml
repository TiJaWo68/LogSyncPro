name: Package Application

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Install 7zip
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full

    - name: Create 7z Package
      run: |
        # Create a deployment directory
        mkdir deployment
        # Copy executable and lib folder
        cp target/LogSyncPro.exe deployment/
        cp -r target/lib deployment/
        # Create the archive
        cd deployment
        7z a ../LogSyncPro.7z *

    - name: Publish to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Deployment version includes run number and attempt to be unique
        VERSION="0.1.0-${{ github.run_number }}.${{ github.run_attempt }}"
        
        mvn deploy:deploy-file \
          -DgroupId=de.in.lsp \
          -DartifactId=LogSyncPro-Distribution \
          -Dversion=$VERSION \
          -Dpackaging=7z \
          -Dfile=LogSyncPro.7z \
          -DrepositoryId=github \
          -Durl=https://maven.pkg.github.com/${{ github.repository }} \
          -Dtoken=$GITHUB_TOKEN

    - name: Cleanup Old Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # List package versions, sorted by date (newest first usually), keep first 3
        # Requires jq
        
        # Package name corresponds to artifactId
        PACKAGE_NAME="de.in.lsp.logsyncpro-distribution"
        # Note: GitHub Packages Maven names are often lowercase group.artifact
        
        # We need to find the correct package name first, sometimes it varies.
        # Assuming de.in.lsp.LogSyncPro-Distribution -> de.in.lsp.logsyncpro-distribution
        
        echo "Fetching versions for $PACKAGE_NAME..."
        
        # Get all versions using GH CLI
        # limit 100 just in case
        versions=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /user/packages/maven/$PACKAGE_NAME/versions \
          --jq 'sort_by(.created_at) | reverse | .[3:] | .[].id')
          
        # If the above fails (e.g. org package), we might need orgs/ORG/packages...
        # Using context ${{ github.repository_owner }} is safer.
        OWNER="${{ github.repository_owner }}"
        
        # Check if user or org
        TYPE=$(gh api "/users/$OWNER" --jq .type)
        if [ "$TYPE" == "Organization" ]; then
            URL="/orgs/$OWNER/packages/maven/$PACKAGE_NAME/versions"
        else
            URL="/users/$OWNER/packages/maven/$PACKAGE_NAME/versions"
        fi
        
        echo "Querying $URL"
        
        versions_to_delete=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "$URL" \
          --jq 'sort_by(.created_at) | reverse | .[3:] | .[].id')

        for id in $versions_to_delete; do
          echo "Deleting version ID $id..."
          gh api \
            --method DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$URL/$id"
        done || echo "No versions to delete or error occurred (first run?)"
